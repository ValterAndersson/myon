<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Povver Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-elevated: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #6366f1;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2a2a2a;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 { font-size: 1.25rem; font-weight: 600; }
        
        .header .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        
        .status-dot.warning { background: var(--warning); }
        .status-dot.error { background: var(--error); }
        
        .tabs {
            display: flex;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .card h3 {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metric { font-size: 2rem; font-weight: 600; }
        .metric.success { color: var(--success); }
        .metric.warning { color: var(--warning); }
        .metric.error { color: var(--error); }
        
        .table-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .table-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 { font-size: 1rem; font-weight: 600; }
        
        .btn {
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn:hover { background: var(--border); color: var(--text-primary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .btn-primary:hover { background: #5558dd; }
        
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        
        table { width: 100%; border-collapse: collapse; }
        
        th, td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        tr:last-child td { border-bottom: none; }
        
        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .badge.enabled, .badge.succeeded { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .badge.running { background: rgba(99, 102, 241, 0.1); color: var(--accent); }
        .badge.pending, .badge.queued { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge.failed, .badge.error { background: rgba(239, 68, 68, 0.1); color: var(--error); }
        
        .time-ago { color: var(--text-secondary); font-size: 0.875rem; }
        
        .actions { display: flex; gap: 0.5rem; align-items: center; }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: var(--surface-elevated);
            color: var(--text-primary);
            text-align: left;
            border-radius: 8px;
            padding: 0.75rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--border);
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        .tooltip-text strong { color: var(--accent); }
        
        /* Log viewer styles */
        .log-viewer {
            background: #000;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .log-entry .timestamp { color: #666; margin-right: 0.5rem; }
        .log-entry .job { color: var(--accent); margin-right: 0.5rem; }
        .log-entry .message { color: #ddd; }
        .log-entry.ERROR .message { color: var(--error); }
        .log-entry.WARNING .message { color: var(--warning); }
        
        .log-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .log-controls select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 6px;
        }
        
        /* History / Changes styles */
        .change-row { cursor: pointer; }
        .change-row:hover { background: var(--surface-elevated); }
        
        .change-details {
            display: none;
            background: var(--surface-elevated);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        
        .change-details.expanded { display: block; }
        
        .field-change {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 4px;
        }
        
        .field-change .before { color: var(--error); text-decoration: line-through; }
        .field-change .after { color: var(--success); }
        
        .loading { text-align: center; padding: 2rem; color: var(--text-secondary); }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 1rem;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üîß Povver Admin</h1>
        <div class="status">
            <span class="status-dot" id="health-dot"></span>
            <span id="health-text">Loading...</span>
        </div>
    </header>
    
    <nav class="tabs">
        <div class="tab active" data-tab="catalog">Catalog Orchestrator</div>
        <div class="tab" data-tab="history">Run History</div>
        <div class="tab" data-tab="logs">Logs</div>
    </nav>
    
    <main class="content">
        <!-- Catalog Orchestrator Tab -->
        <div id="catalog" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>Queue Pending</h3>
                    <div class="metric" id="queue-pending">-</div>
                </div>
                <div class="card">
                    <h3>Running</h3>
                    <div class="metric" id="queue-running">-</div>
                </div>
                <div class="card">
                    <h3>Succeeded</h3>
                    <div class="metric success" id="queue-succeeded">-</div>
                </div>
                <div class="card">
                    <h3>Failed</h3>
                    <div class="metric error" id="queue-failed">-</div>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h2>‚òÅÔ∏è Cloud Run Jobs</h2>
                    <button class="btn" onclick="refreshAll()">‚Üª Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Job</th>
                            <th>Description</th>
                            <th>Executions</th>
                            <th>Last Run</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cloudrun-table">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h2>‚è∞ Scheduled Triggers</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Trigger</th>
                            <th>Schedule</th>
                            <th>Next Run</th>
                            <th>State</th>
                        </tr>
                    </thead>
                    <tbody id="scheduler-table">
                        <tr><td colspan="4" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h2>üìã Recent Queue Jobs</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Type</th>
                            <th>Family</th>
                            <th>Status</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-table">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="table-container">
                <div class="table-header">
                    <h2>üìú Run History & Changes</h2>
                    <button class="btn" onclick="fetchHistory()">‚Üª Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Exercise</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Changes</th>
                        </tr>
                    </thead>
                    <tbody id="history-table">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="log-controls">
                <label>Filter by job:</label>
                <select id="log-job-filter">
                    <option value="">All Jobs</option>
                    <option value="catalog-worker">catalog-worker</option>
                    <option value="catalog-review">catalog-review</option>
                    <option value="catalog-cleanup">catalog-cleanup</option>
                    <option value="catalog-watchdog">catalog-watchdog</option>
                </select>
                <button class="btn" id="log-stream-btn" onclick="toggleLogStream()">‚ñ∂ Start Streaming</button>
                <button class="btn" onclick="clearLogs()">Clear</button>
                <span id="log-status" style="color: var(--text-secondary); font-size: 0.85rem;"></span>
            </div>
            <div class="log-viewer" id="log-viewer">
                <div class="loading">Click "Start Streaming" to begin fetching logs...</div>
            </div>
        </div>
    </main>
    
    <script>
        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                // Load data for specific tabs
                if (tab.dataset.tab === 'history') fetchHistory();
            });
        });
        
        function timeAgo(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        function timeUntil(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const now = new Date();
            const seconds = Math.floor((date - now) / 1000);
            if (seconds < 0) return 'now';
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
            return `${Math.floor(seconds / 86400)}d`;
        }
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            return new Date(isoString).toLocaleTimeString();
        }
        
        async function triggerJob(jobName) {
            if (!confirm(`Trigger ${jobName} now?`)) return;
            
            try {
                const resp = await fetch(`/api/cloudrun/jobs/${jobName}/trigger`, { method: 'POST' });
                const data = await resp.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    fetchCloudRun();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (e) {
                alert(`‚ùå Error: ${e.message}`);
            }
        }
        
        async function fetchScheduler() {
            try {
                const resp = await fetch('/api/scheduler/jobs');
                const data = await resp.json();
                
                if (!data.success) throw new Error(data.error);
                
                const tbody = document.getElementById('scheduler-table');
                if (data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No scheduler jobs found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.jobs.map(job => `
                    <tr>
                        <td>${job.name}</td>
                        <td><code>${job.schedule}</code></td>
                        <td class="time-ago">${timeUntil(job.next_run)}</td>
                        <td><span class="badge ${job.state.toLowerCase()}">${job.state}</span></td>
                    </tr>
                `).join('');
            } catch (e) {
                document.getElementById('scheduler-table').innerHTML = 
                    `<tr><td colspan="4" class="error-message">${e.message}</td></tr>`;
            }
        }
        
        async function fetchCloudRun() {
            try {
                const resp = await fetch('/api/cloudrun/jobs');
                const data = await resp.json();
                
                if (!data.success) throw new Error(data.error);
                
                const tbody = document.getElementById('cloudrun-table');
                if (data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No Cloud Run jobs found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.jobs.map(job => {
                    const exec = job.latest_execution;
                    const status = exec ? exec.status : 'NEVER_RUN';
                    const lastRun = exec ? timeAgo(exec.completion_time || exec.create_time) : '-';
                    
                    return `
                        <tr>
                            <td><strong>${job.name}</strong></td>
                            <td style="max-width: 200px; font-size: 0.8rem; color: var(--text-secondary);">
                                ${job.description || '-'}
                            </td>
                            <td>${job.execution_count || 0}</td>
                            <td class="time-ago">${lastRun}</td>
                            <td><span class="badge ${status.toLowerCase()}">${status}</span></td>
                            <td class="actions">
                                <button class="btn btn-sm btn-primary" onclick="triggerJob('${job.name}')" 
                                    ${status === 'RUNNING' ? 'disabled' : ''}>
                                    ‚ñ∂ Run
                                </button>
                                <div class="tooltip">
                                    <button class="btn btn-sm">?</button>
                                    <span class="tooltip-text">
                                        <strong>${job.name}</strong><br>
                                        ${job.description || 'No description'}<br><br>
                                        <strong>Defaults:</strong> ${job.default_params || 'N/A'}<br>
                                        <strong>Schedule:</strong> ${job.schedule || 'N/A'}
                                    </span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                document.getElementById('cloudrun-table').innerHTML = 
                    `<tr><td colspan="6" class="error-message">${e.message}</td></tr>`;
            }
        }
        
        async function fetchQueue() {
            try {
                const resp = await fetch('/api/firestore/queue');
                const data = await resp.json();
                
                if (!data.success) throw new Error(data.error);
                
                document.getElementById('queue-pending').textContent = data.queue.pending;
                document.getElementById('queue-running').textContent = data.queue.running;
                document.getElementById('queue-failed').textContent = data.queue.failed;
                document.getElementById('queue-succeeded').textContent = 
                    (data.queue.by_status?.succeeded || 0) + (data.queue.by_status?.succeeded_dry_run || 0);
                
                const tbody = document.getElementById('jobs-table');
                if (data.recent_jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No recent jobs</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.recent_jobs.map(job => `
                    <tr>
                        <td><code style="font-size: 0.75rem;">${job.id.substring(0, 16)}...</code></td>
                        <td>${job.type || '-'}</td>
                        <td>${job.family_slug || '-'}</td>
                        <td><span class="badge ${job.status}">${job.status}</span></td>
                        <td class="time-ago">${timeAgo(job.created_at)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                document.getElementById('jobs-table').innerHTML = 
                    `<tr><td colspan="5" class="error-message">${e.message}</td></tr>`;
            }
        }
        
        async function fetchHistory() {
            try {
                const resp = await fetch('/api/firestore/run-history');
                const data = await resp.json();
                
                if (!data.success) throw new Error(data.error);
                
                const tbody = document.getElementById('history-table');
                if (data.history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No run history</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.history.map(h => {
                    const hasChanges = h.changes && Object.keys(h.changes).length > 0;
                    const changesHtml = hasChanges ? 
                        Object.entries(h.changes).map(([field, val]) => `
                            <div class="field-change">
                                <strong>${field}:</strong>
                                <span class="before">${JSON.stringify(val.before || val.old)}</span> ‚Üí 
                                <span class="after">${JSON.stringify(val.after || val.new)}</span>
                            </div>
                        `).join('') : '';
                    
                    return `
                        <tr class="change-row" onclick="this.nextElementSibling.classList.toggle('expanded')">
                            <td class="time-ago">${timeAgo(h.completed_at)}</td>
                            <td>${h.job_type || '-'}</td>
                            <td style="font-size: 0.8rem;">${h.family_slug || h.exercise_id || '-'}</td>
                            <td><span class="badge ${h.status}">${h.status}</span></td>
                            <td>${h.duration_ms ? (h.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
                            <td>${h.changes_count || 0}</td>
                        </tr>
                        <tr><td colspan="6" style="padding: 0;">
                            <div class="change-details">
                                ${h.summary ? `<p style="margin-bottom: 0.5rem;">${h.summary}</p>` : ''}
                                ${changesHtml || '<p style="color: var(--text-secondary);">No field changes recorded</p>'}
                            </div>
                        </td></tr>
                    `;
                }).join('');
            } catch (e) {
                document.getElementById('history-table').innerHTML = 
                    `<tr><td colspan="6" class="error-message">${e.message}</td></tr>`;
            }
        }
        
        async function fetchStatus() {
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                
                const dot = document.getElementById('health-dot');
                const text = document.getElementById('health-text');
                
                dot.className = 'status-dot ' + (data.health === 'healthy' ? '' : data.health);
                text.textContent = data.health === 'healthy' ? 'All systems operational' : 
                    data.issues.join(', ');
            } catch (e) {
                document.getElementById('health-text').textContent = 'Connection error';
                document.getElementById('health-dot').className = 'status-dot error';
            }
        }
        
        // Log streaming
        let logEventSource = null;
        let isStreaming = false;
        
        function toggleLogStream() {
            if (isStreaming) {
                stopLogStream();
            } else {
                startLogStream();
            }
        }
        
        function startLogStream() {
            const jobFilter = document.getElementById('log-job-filter').value;
            const url = `/api/logs/stream${jobFilter ? `?job=${jobFilter}` : ''}`;
            
            logEventSource = new EventSource(url);
            isStreaming = true;
            
            document.getElementById('log-stream-btn').textContent = '‚èπ Stop Streaming';
            document.getElementById('log-status').textContent = 'Streaming...';
            document.getElementById('log-viewer').innerHTML = '';
            
            logEventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.error) {
                    appendLog({ severity: 'ERROR', message: data.error, timestamp: new Date().toISOString() });
                    return;
                }
                appendLog(data);
            };
            
            logEventSource.onerror = () => {
                document.getElementById('log-status').textContent = 'Connection lost, retrying...';
            };
        }
        
        function stopLogStream() {
            if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
            }
            isStreaming = false;
            document.getElementById('log-stream-btn').textContent = '‚ñ∂ Start Streaming';
            document.getElementById('log-status').textContent = 'Stopped';
        }
        
        function appendLog(log) {
            const viewer = document.getElementById('log-viewer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${log.severity}`;
            
            const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '';
            entry.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <span class="job">[${log.job_name || 'unknown'}]</span>
                <span class="message">${log.message}</span>
            `;
            
            viewer.appendChild(entry);
            viewer.scrollTop = viewer.scrollHeight;
            
            // Limit entries
            while (viewer.children.length > 500) {
                viewer.removeChild(viewer.firstChild);
            }
        }
        
        function clearLogs() {
            document.getElementById('log-viewer').innerHTML = 
                '<div style="color: var(--text-secondary);">Logs cleared</div>';
        }
        
        async function refreshAll() {
            await Promise.all([
                fetchScheduler(),
                fetchCloudRun(),
                fetchQueue(),
                fetchStatus(),
            ]);
        }
        
        // Initial load
        refreshAll();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
